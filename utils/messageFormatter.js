const botBehavior = require('../data/botBehavior');

/**
 * Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ² ÑĞ²ÑĞ·Ğ¸
 * ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚: voice, whatsapp, sms
 */

const messageFormatter = {
    /**
     * Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ¾Ğ³Ğ¾ ĞºĞ°Ğ½Ğ°Ğ»Ğ° (TTS)
     * Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ÑƒÑ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ Ğ¸Ğ· botBehavior
     */
    formatForVoice(text) {
        return botBehavior.cleanTextForTTS(text);
    },

    /**
     * Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ WhatsApp
     * - Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ emoji Ğ¸ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
     * - Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ¸Ñ€ÑƒĞµÑ‚ Ñ‚ĞµĞºÑÑ‚ Ğ´Ğ»Ñ Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼Ğ¾ÑÑ‚Ğ¸
     * - Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµÑ‚ Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğ¸Ñ‚ĞµĞ»Ğ¸ Ğ´Ğ»Ñ ÑĞ¿Ğ¸ÑĞºĞ¾Ğ²
     */
    formatForWhatsApp(text) {
        if (!text) return '';
        
        // Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ markdown ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ñ‹, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ WhatsApp Ğ½Ğµ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾
        text = text.replace(/\*\*/g, '*'); // Ğ”Ğ²Ğ¾Ğ¹Ğ½Ñ‹Ğµ Ğ·Ğ²ĞµĞ·Ğ´Ğ¾Ñ‡ĞºĞ¸ -> Ğ¾Ğ´Ğ¸Ğ½Ğ°Ñ€Ğ½Ñ‹Ğµ (Ğ¶Ğ¸Ñ€Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚)
        text = text.replace(/#{1,6}\s/g, ''); // Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¸ markdown
        
        // Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ñ‚ĞµĞ³Ğ¸ [GENDER: ...]
        text = text.replace(/\[GENDER:\s*(male|female)\]/gi, '').trim();
        
        // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ emoji Ğ¸ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ
        text = text.trim();
        
        return text;
    },

    /**
     * Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ SMS
     * - ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
     * - Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ²ÑĞµ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
     * - ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ğµ ~300 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ² (2 SMS ÑĞµĞ³Ğ¼ĞµĞ½Ñ‚Ğ°)
     */
    formatForSMS(text) {
        if (!text) return '';
        
        // Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ²ÑĞµ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
        text = text.replace(/[*_#`~]/g, ''); // Markdown ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ñ‹
        text = text.replace(/\[GENDER:\s*(male|female)\]/gi, '').trim(); // Ğ¢ĞµĞ³Ğ¸ Ğ³ĞµĞ½Ğ´ĞµÑ€Ğ°
        
        // Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ emoji (Ğ¾Ğ½Ğ¸ Ğ·Ğ°Ğ½Ğ¸Ğ¼Ğ°ÑÑ‚ Ğ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ¼ĞµÑÑ‚Ğ° Ğ² SMS)
        text = text.replace(/[\u{1F300}-\u{1F9FF}]/gu, '');
        text = text.replace(/[\u{2600}-\u{26FF}]/gu, '');
        text = text.replace(/[\u{2700}-\u{27BF}]/gu, '');
        
        // Ğ¡Ğ¾ĞºÑ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ¼Ğ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ±ĞµĞ»Ñ‹
        text = text.replace(/\s+/g, ' ').trim();
        
        // Ğ•ÑĞ»Ğ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ´Ğ»Ğ¸Ğ½Ğ½Ğ¾Ğµ, Ğ¾Ğ±Ñ€ĞµĞ·Ğ°ĞµĞ¼ Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ğµ
        const MAX_SMS_LENGTH = 300; // ~2 SMS ÑĞµĞ³Ğ¼ĞµĞ½Ñ‚Ğ°
        if (text.length > MAX_SMS_LENGTH) {
            text = text.substring(0, MAX_SMS_LENGTH - 3) + '...';
        }
        
        return text;
    },

    /**
     * Ğ£Ğ½Ğ¸Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ñ‚ĞµÑ€ - Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ Ğ½ÑƒĞ¶Ğ½Ñ‹Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ¿Ğ¾ ĞºĞ°Ğ½Ğ°Ğ»Ñƒ
     */
    format(text, channel) {
        switch (channel) {
            case 'voice':
                return this.formatForVoice(text);
            case 'whatsapp':
                return this.formatForWhatsApp(text);
            case 'sms':
                return this.formatForSMS(text);
            default:
                console.warn(`âš ï¸ ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğ¹ ĞºĞ°Ğ½Ğ°Ğ»: ${channel}, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ`);
                return text;
        }
    },

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğµ Ğ´Ğ»Ñ ĞºĞ°Ğ½Ğ°Ğ»Ğ°
     */
    getGreeting(channel) {
        const greetings = {
            voice: botBehavior.getMessage('initial'),
            whatsapp: '×©×œ×•×! ğŸ‘‹ ×”×’×¢×ª ×œ××—×œ×§×ª ×”××›×™×¨×•×ª ×©×œ ×—×‘×¨×ª ×œ×™×“×¨. ×× ×™ ×”×¢×•×–×¨×ª ×”××™×©×™×ª. ××™×š ××¤×©×¨ ×œ×¢×–×•×¨?',
            sms: '×©×œ×•×! ×—×‘×¨×ª ×œ×™×“×¨. ××™×š ××¤×©×¨ ×œ×¢×–×•×¨?'
        };
        
        return greetings[channel] || greetings.voice;
    },

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ ĞºĞ°Ğ½Ğ°Ğ»Ğ°
     */
    getMessage(type, channel) {
        // Ğ”Ğ»Ñ Ğ³Ğ¾Ğ»Ğ¾ÑĞ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ÑƒÑ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ
        if (channel === 'voice') {
            return botBehavior.getMessage(type);
        }
        
        // Ğ”Ğ»Ñ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ñ… ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ² - Ğ°Ğ´Ğ°Ğ¿Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
        const messages = {
            checking: {
                whatsapp: '×¨×§ ×¨×’×¢, ×× ×™ ×‘×•×“×§×ª... â³',
                sms: '×¨×§ ×¨×’×¢, ×× ×™ ×‘×•×“×§×ª...'
            },
            noSpeech: {
                whatsapp: '×œ× ×”×‘× ×ª×™, ××¤×©×¨ ×œ×—×–×•×¨ ×¢×œ ×–×”? ğŸ¤”',
                sms: '×œ× ×”×‘× ×ª×™, ××¤×©×¨ ×œ×—×–×•×¨?'
            },
            apiError: {
                whatsapp: '×¡×œ×™×—×”, ×™×© ×ª×§×œ×” ×‘××¢×¨×›×ª. ×× × × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨ ğŸ”§',
                sms: '×¡×œ×™×—×”, ×™×© ×ª×§×œ×”. × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨'
            },
            transferring: {
                whatsapp: '××¢×‘×™×¨×” ××•×ª×š ×œ× ×¦×™×’ ××›×™×¨×•×ª... ğŸ“',
                sms: '××¢×‘×™×¨×” ×œ× ×¦×™×’...'
            },
            operatorUnavailable: {
                whatsapp: '××¦×˜×¢×¨×ª, × ×¦×™×’ ×”××›×™×¨×•×ª ××™× ×• ×–××™×Ÿ ×›×¨×’×¢. ××™×š ××•×›×œ ×œ×¢×–×•×¨ ×œ×š ×‘× ×•×©× ××—×¨? ğŸ’¬',
                sms: '×”× ×¦×™×’ ×œ× ×–××™×Ÿ. ××™×š ××•×›×œ ×œ×¢×–×•×¨?'
            }
        };
        
        if (messages[type] && messages[type][channel]) {
            return messages[type][channel];
        }
        
        // Fallback Ğ½Ğ° Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
        return botBehavior.getMessage(type);
    }
};

module.exports = messageFormatter;
